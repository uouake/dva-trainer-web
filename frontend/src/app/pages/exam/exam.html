<div class="exam-root">
  <!-- Intro (light) -->
  <div *ngIf="phase === 'intro'" class="intro">
    <a routerLink="/dashboard" class="back muted">‚Üê Dashboard</a>

    <h1>Simulateur d'Examen</h1>
    <p class="muted">Conditions r√©elles de l'examen AWS DVA-C02. Pr√™t ?</p>

    <div *ngIf="loading">Chargement‚Ä¶</div>
    <div *ngIf="error" class="error">Erreur: {{ error }}</div>

    <div class="card intro-card">
      <div class="grid-2">
        <div class="mini muted">
          <div class="mini-value font-mono">65</div>
          <div class="mini-label">Questions</div>
        </div>
        <div class="mini muted">
          <div class="mini-value font-mono">130 min</div>
          <div class="mini-label">Dur√©e</div>
        </div>
        <div class="mini muted">
          <div class="mini-value font-mono">72%</div>
          <div class="mini-label">Score de passage</div>
        </div>
        <div class="mini muted">
          <div class="mini-value font-mono">QCM</div>
          <div class="mini-label">Format</div>
        </div>
      </div>

      <div class="bullets muted">
        <div>‚Ä¢ Vous pouvez naviguer librement entre les questions</div>
        <div>‚Ä¢ Marquez les questions pour les revoir plus tard</div>
        <div>‚Ä¢ Le chronom√®tre d√©marre imm√©diatement</div>
      </div>
    </div>

    <button class="btn-primary w-full" (click)="startExam()" [disabled]="loading">Commencer l'examen</button>
  </div>

  <!-- Exam (dark) -->
  <div *ngIf="phase === 'exam'" class="exam-mode runner">
    <header class="runner-top">
      <div class="left">
        <span class="font-mono muted">{{ index + 1 }}/{{ questions.length }}</span>
        <span class="muted"><span class="primary">{{ answeredCount() }}</span> r√©pondu</span>
      </div>

      <div class="timer font-mono" role="timer" aria-live="polite" aria-atomic="true" [attr.aria-label]="'Temps restant: ' + formatTime(secondsLeft)">‚è± {{ formatTime(secondsLeft) }}</div>

      <div class="right">
        <button class="icon" (click)="showGrid = !showGrid" [class.icon-active]="showGrid">‚ñ¶</button>
        <button class="btn-primary small" (click)="showSubmitConfirm = true">Terminer</button>
      </div>
    </header>

    <div class="runner-body">
      <div class="main">
        <div *ngIf="current as q" class="exam-card card">
          <div class="qhead">
            <span class="badge font-mono muted">{{ index + 1 }}/{{ questions.length }}</span>
            <span class="pill">{{ (q.domainKey ?? 'unknown') === 'development' ? 'D√©veloppement' : (q.domainKey ?? 'unknown') === 'security' ? 'Security' : (q.domainKey ?? 'unknown') === 'deployment' ? 'Deployment' : (q.domainKey ?? 'unknown') === 'troubleshooting' ? 'Troubleshooting & Optimization' : 'Unknown' }}</span>
            <button class="flag" (click)="toggleFlag()" [attr.aria-label]="isFlagged(q) ? 'Retirer le marqueur de la question ' + (index + 1) : 'Marquer la question ' + (index + 1) + ' pour revision'" [attr.aria-pressed]="isFlagged(q)">{{ isFlagged(q) ? 'üö©' : '‚öë' }}</button>
          </div>

          <pre class="stem" [appGlossaryHandler]="q.stem" [innerHTML]="q.stem | glossary"></pre>

          <div class="choices">
            <button
              class="choice"
              *ngFor="let k of choiceKeys(q)"
              (click)="pick(k)"
              [disabled]="submittingAttempt || answers.has(q.id)"
              [class.selected]="chosenFor(q) === k"
              [appGlossaryHandler]="q.choices[k]"
            >
              <div class="choice-k">{{ k }}</div>
              <div class="choice-body" [innerHTML]="q.choices[k] | glossary"></div>
            </button>
          </div>
        </div>

        <div class="nav">
          <button class="ghost" (click)="prev()" [disabled]="index === 0">‚Üê Pr√©c√©dent</button>
          <button class="ghost primary-ghost" (click)="next()" [disabled]="index >= questions.length - 1">Suivant ‚Üí</button>
        </div>
      </div>

      <aside *ngIf="showGrid" class="side card exam-card" aria-label="Navigation entre les questions">
        <div class="side-title" id="nav-title">Navigation</div>
        <div class="grid" role="grid" aria-labelledby="nav-title">
          <button
            *ngFor="let q of questions; let i = index"
            (click)="goTo(i)"
            [class.current]="i === index"
            [class.answered]="chosenFor(q) !== null"
            [class.flagged]="isFlagged(q)"
            [attr.aria-label]="'Question ' + (i + 1) + (chosenFor(q) ? ' - r√©pondu' : '') + (isFlagged(q) ? ' - marqu√©e' : '') + (i === index ? ' - question actuelle' : '')"
            [attr.aria-current]="i === index ? 'true' : null"
            role="gridcell"
          >
            {{ i + 1 }}
          </button>
        </div>
        <div class="legend muted">
          <div><span class="dot answered"></span> R√©pondu</div>
          <div><span class="dot"></span> Non r√©pondu</div>
          <div><span class="dot flagged"></span> Marqu√©</div>
        </div>
      </aside>
    </div>

    <!-- Submit confirm -->
    <div *ngIf="showSubmitConfirm" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-desc">
      <div class="modal-card card exam-card">
        <h3 id="confirm-title">Terminer l'examen ?</h3>
        <p class="muted" id="confirm-desc">{{ answeredCount() }}/{{ questions.length }} questions r√©pondues</p>
        <div class="modal-actions">
          <button class="ghost" (click)="showSubmitConfirm = false" aria-label="Continuer l'examen">Continuer</button>
          <button class="btn-primary" (click)="submit()" aria-label="Terminer et soumettre l'examen">Terminer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results (dark) -->
  <div *ngIf="phase === 'results'" class="exam-mode results">
    <div class="card exam-card results-card">
      <h1>R√©sultat</h1>
      <p>Score: <strong>{{ score().correct }}/{{ score().total }}</strong> ({{ score().percent }}%)</p>

      <details>
        <summary>Voir les questions rat√©es</summary>
        <ol>
          <li *ngFor="let q of questions">
            <div *ngIf="chosenFor(q) && chosenFor(q) !== q.answer">
              <strong>Q{{ q.questionNumber }}</strong> ‚Äî Ta r√©ponse: {{ chosenFor(q) }} | Bonne r√©ponse: {{ q.answer }}
              <p class="muted">{{ q.frExplanation }}</p>
            </div>
          </li>
        </ol>
      </details>

      <button class="btn-primary" (click)="phase = 'intro'">Retour</button>
    </div>
  </div>
</div>
